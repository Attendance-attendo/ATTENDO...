\<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance | Manager</title>
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #ffffff; --border: rgba(255,255,255,0.1); --danger: #ef4444; --success: #4ade80; --warning: #f59e0b; }
        body.light-mode { --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --border: #cbd5e1; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; transition: 0.3s; display: flex; flex-direction: column; align-items: center; }
        .glass-card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--border); width: 100%; max-width: 550px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); box-sizing: border-box; }
        button { background: var(--primary); border: none; font-weight: bold; cursor: pointer; color: white; }
        .hidden { display: none; }
        .tab-btn { background: var(--card); flex: 1; margin: 0 5px; opacity: 0.6; }
        .active-tab { opacity: 1; border: 2px solid var(--primary); }
        .student-row { display: flex; justify-content: space-between; align-items: center; background: rgba(100,100,100,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .status-badge { font-weight: bold; font-size: 0.8rem; padding: 4px 8px; border-radius: 5px; }
        .theme-btn { position: fixed; top: 10px; right: 10px; width: auto; font-size: 0.8rem; padding: 8px; }
    </style>
</head>
<body onload="checkInit()">

    <button class="theme-btn" onclick="toggleTheme()">ðŸŒ“ Theme</button>

    <div id="auth-screen" class="glass-card">
        <h1>Attendance</h1>
        <input type="text" id="l-user" placeholder="Username">
        <input type="password" id="l-pass" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
    </div>

    <div id="dashboard" class="hidden" style="width:100%; max-width:600px;">
        <div style="display:flex; width:100%; margin-bottom:15px;">
            <button id="tab-take" class="tab-btn active-tab" onclick="switchTab('take')">Attendance</button>
            <button id="tab-manage" class="tab-btn" onclick="switchTab('manage')">Manage Roster</button>
        </div>

        <div id="manage-pane" class="glass-card hidden">
            <h3>Add Student to School</h3>
            <input type="text" id="r-name" placeholder="Full Name">
            <input type="number" id="r-roll" placeholder="Roll No">
            <select id="r-class"><option>Class 11</option><option>Class 12</option></select>
            <select id="r-sec"><option>Sec A</option><option>Sec B</option></select>
            <button onclick="saveToRoster()" style="background:var(--success)">Save to Database</button>
            <hr style="opacity:0.1; margin:20px 0;">
            <h4>All Registered Students</h4>
            <div id="roster-list" style="max-height:200px; overflow-y:auto; text-align:left;"></div>
        </div>

        <div id="take-pane" class="glass-card">
            <h3>Mark Daily Roll</h3>
            <input type="date" id="att-date">
            <div style="display:flex; gap:10px;">
                <select id="f-class" onchange="filterList()"><option value="">Select Class</option><option>Class 11</option><option>Class 12</option></select>
                <select id="f-sec" onchange="filterList()"><option value="">Select Sec</option><option>Sec A</option><option>Sec B</option></select>
            </div>
            <select id="att-period"><option>Period 1</option><option>Period 2</option><option>Period 3</option></select>
            <div id="filtered-list" style="margin-top:20px;"></div>
        </div>

        <button onclick="logout()" style="background:var(--danger); margin-top:20px;">Logout</button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrJQsxWPbZ37Q1rW3MF6JeMOeid7sSjtk5ZwkrwqvWdAYPl33C0Lztf8ODsHtzObt9Ug/exec";
        let fullRoster = [];

        function checkInit() {
            if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
            if(localStorage.getItem('attendo_user')) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadRoster();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }

        function switchTab(t) {
            document.getElementById('take-pane').classList.toggle('hidden', t !== 'take');
            document.getElementById('manage-pane').classList.toggle('hidden', t !== 'manage');
            document.getElementById('tab-take').classList.toggle('active-tab', t === 'take');
            document.getElementById('tab-manage').classList.toggle('active-tab', t === 'manage');
            loadRoster();
        }

        async function saveToRoster() {
            const data = { action: "addToRoster", name: document.getElementById('r-name').value, roll: document.getElementById('r-roll').value, selectedClass: document.getElementById('r-class').value, section: document.getElementById('r-sec').value };
            await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
            alert("Saved!"); loadRoster();
        }

        async function deleteStudent(roll, cls) {
            if(!confirm("Remove student?")) return;
            await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "deleteFromRoster", roll: roll, selectedClass: cls }) });
            loadRoster();
        }

        async function loadRoster() {
            const res = await fetch(`${SCRIPT_URL}?get=roster`);
            fullRoster = await res.json();
            document.getElementById('roster-list').innerHTML = fullRoster.map(s => `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>${s.name} (${s.class})</span>
                    <span style="color:var(--danger); cursor:pointer;" onclick="deleteStudent('${s.roll}','${s.class}')">Delete</span>
                </div>
            `).join('');
            filterList();
        }

        function filterList() {
            const cls = document.getElementById('f-class').value;
            const sec = document.getElementById('f-sec').value;
            const filtered = fullRoster.filter(s => s.class === cls && s.section === sec);
            document.getElementById('filtered-list').innerHTML = filtered.length ? filtered.map(s => `
                <div class="student-row">
                    <span><b>${s.name}</b></span>
                    <div id="btn-grp-${s.roll}" style="display:flex; gap:5px;">
                        <button style="width:40px; background:var(--success)" onclick="mark('${s.name}','${s.roll}','Present')">P</button>
                        <button style="width:40px; background:var(--danger)" onclick="mark('${s.name}','${s.roll}','Leave')">L</button>
                        <button style="width:50px; background:var(--warning)" onclick="mark('${s.name}','${s.roll}','Late')">Late</button>
                    </div>
                </div>
            `).join('') : "<p style='opacity:0.5'>No students found for this selection.</p>";
        }

        async function mark(name, roll, status) {
            const data = { action: "markAttendance", date: document.getElementById('att-date').value, name: name, roll: roll, selectedClass: document.getElementById('f-class').value, section: document.getElementById('f-sec').value, period: document.getElementById('att-period').value, status: status };
            await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
            document.getElementById(`btn-grp-${roll}`).innerHTML = `<span class="status-badge">âœ… ${status}</span>`;
        }

        async function handleLogin() {
            const user = document.getElementById('l-user').value;
            const pass = document.getElementById('l-pass').value;
            const res = await fetch(`${SCRIPT_URL}?action=login&user=${user}&pass=${pass}`);
            if ((await res.text()).trim() === "valid") {
                localStorage.setItem('attendo_user', user);
                location.reload();
            } else alert("Wrong Login");
        }

        function logout() { localStorage.removeItem('attendo_user'); location.reload(); }
    </script>
</body>
</html>
