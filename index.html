<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendo Pro | Attendance System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.7);
            --success: #10b981;
            --danger: #f43f5e;
            --text: #f8fafc;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .card {
            background: var(--card);
            backdrop-filter: blur(12px);
            padding: 2rem;
            border-radius: 28px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 24px;
            animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { font-size: 2.2rem; font-weight: 800; text-align: center; color: var(--primary); letter-spacing: -1.5px; margin-bottom: 2rem; }

        input, select, button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 23, 42, 0.8);
            color: white;
            font-size: 15px;
            transition: var(--transition);
        }

        button { background: var(--primary); border: none; font-weight: 700; cursor: pointer; }
        button:hover { filter: brightness(1.15); transform: translateY(-2px); }
        button:active { transform: translateY(0); }

        .hidden { display: none; }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 18px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn-p { background: var(--success); width: 44px; height: 44px; padding: 0; margin: 0; border-radius: 14px; }
        .btn-a { background: var(--danger); width: 44px; height: 44px; padding: 0; margin: 0; border-radius: 14px; }

        #toast {
            position: fixed;
            bottom: 30px;
            background: var(--primary);
            color: white;
            padding: 14px 28px;
            border-radius: 20px;
            font-weight: 600;
            visibility: hidden;
            z-index: 1000;
        }

        #toast.show { 
            visibility: visible; 
            animation: toastPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
        }

        @keyframes toastPop {
            0% { transform: translateY(50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .link { font-size: 0.85rem; color: var(--primary); cursor: pointer; font-weight: 600; display: inline-block; margin-top: 10px;}
    </style>
</head>
<body onload="initApp()">

    <div id="toast">Ready</div>

    <div id="auth-card" class="card">
        <h1>ATTENDO</h1>
        <div id="login-form">
            <input type="text" id="l-email" placeholder="Email Address">
            <input type="password" id="l-pass" placeholder="Password">
            <button onclick="login()">Sign In</button>
            <div style="text-align:center;">
                <span class="link" onclick="toggleAuth('signup')">Create Account</span> â€¢ 
                <span class="link" onclick="toggleAuth('forgot')">Forgot PIN?</span>
            </div>
        </div>

        <div id="signup-form" class="hidden">
            <input type="text" id="s-email" placeholder="Email Address">
            <input type="text" id="s-name" placeholder="Full Name">
            <input type="password" id="s-pass" placeholder="Password">
            <input type="text" id="s-recovery" placeholder="4-Digit PIN">
            <button onclick="signup()">Register</button>
            <span class="link" onclick="toggleAuth('login')">Back to Sign In</span>
        </div>

        <div id="forgot-form" class="hidden">
            <input type="text" id="f-email" placeholder="Email">
            <input type="text" id="f-recovery" placeholder="Recovery PIN">
            <input type="password" id="f-newpass" placeholder="New Password">
            <button onclick="resetPass()">Update Password</button>
            <span class="link" onclick="toggleAuth('login')">Back</span>
        </div>
    </div>

    <div id="main-ui" class="hidden" style="width: 100%; max-width: 440px;">
        <div id="admin-panel" class="card hidden" style="border-left: 5px solid var(--primary);">
            <h3 style="color: var(--primary); margin:0;">Admin Console</h3>
            <div id="request-list"></div>
            
            <hr style="opacity:0.05; margin:20px 0;">
            <button onclick="updateWebsite()" style="background:#4338ca; margin-bottom: 15px;">Update Website (Sync GitHub)</button>
            
            <h3 style="font-size: 1rem;">Add Student</h3>
            <input type="text" id="st-name" placeholder="Name">
            <input type="text" id="st-roll" placeholder="Roll">
            <div style="display:flex; gap:10px;">
                <select id="st-class">
                    <option>Class 6</option><option>Class 7</option><option>Class 8</option>
                    <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                </select>
                <select id="st-sec"><option>Sec A</option><option>Sec B</option></select>
            </div>
            <button onclick="addStudent()" style="background:var(--success)">Add Student</button>
        </div>

        <div class="card">
            <h2 id="welcome-msg" style="margin:0;">Dashboard</h2>
            <div id="request-section" class="hidden">
                <p style="opacity:0.6; font-size: 0.9rem;">Assign a classroom:</p>
                <select id="req-class"><option>Class 6</option><option>Class 11</option><option>Class 12</option></select>
                <select id="req-sec"><option>Sec A</option><option>Sec B</option></select>
                <button onclick="sendRequest()">Request Access</button>
            </div>
            <div id="teacher-tools" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span>Room: <b id="assigned-room" style="color:var(--primary)"></b></span>
                    <button onclick="downloadCSV()" style="width:auto; padding:5px 12px; font-size:12px; background:#334155;">CSV Export</button>
                </div>
                <div id="att-list"></div>
            </div>
            <button onclick="logout()" style="background:transparent; border:1px solid var(--danger); color:var(--danger); margin-top:30px;">Sign Out</button>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbzvW2IsL91EGwOMuyHkcs__zLVQ1WkZrK4NlsVHLG8iBTdDa8UdxhjvD4N47kf0kYAy4w/exec";
        const ADMIN = "yuvansood1234@gmail.com";

        function toast(m) { 
            const t = document.getElementById("toast"); 
            t.innerText = m; 
            t.classList.remove('show');
            void t.offsetWidth;
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000); 
        }

        function toggleAuth(m) {
            ['login-form', 'signup-form', 'forgot-form'].forEach(f => document.getElementById(f).classList.add('hidden'));
            document.getElementById(m + '-form').classList.remove('hidden');
        }

        async function login() {
            const e=document.getElementById('l-email').value.trim(), p=document.getElementById('l-pass').value.trim();
            toast("Authenticating...");
            const res = await fetch(`${API}?action=login&email=${encodeURIComponent(e)}&pass=${encodeURIComponent(p)}`);
            if((await res.text()).trim()==="valid") { sessionStorage.setItem('u_email', e.toLowerCase()); location.reload(); }
            else toast("Login Failed");
        }

        async function signup() {
            const data = { action:"createAccount", email:document.getElementById('s-email').value, name:document.getElementById('s-name').value, pass:document.getElementById('s-pass').value, recovery:document.getElementById('s-recovery').value };
            const res = await fetch(API, { method:"POST", body:JSON.stringify(data)});
            toast(await res.text());
            toggleAuth('login');
        }

        async function resetPass() {
            const data = { action:"resetPassword", email:document.getElementById('f-email').value, recovery:document.getElementById('f-recovery').value, newPass:document.getElementById('f-newpass').value };
            const res = await fetch(API, { method:"POST", body:JSON.stringify(data)});
            toast(await res.text());
            toggleAuth('login');
        }

        async function initApp() {
            const user = sessionStorage.getItem('u_email');
            if(!user) return;
            document.getElementById('auth-card').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = "Hi, " + user.split('@')[0];

            const statusRes = await fetch(`${API}?action=checkStatus&email=${user}`);
            const status = await statusRes.json();

            if(user === ADMIN) {
                document.getElementById('admin-panel').classList.remove('hidden');
                loadRequests();
            }

            if(status.role === "teacher") {
                document.getElementById('assigned-room').innerText = status.class + " " + status.section;
                document.getElementById('teacher-tools').classList.remove('hidden');
                fetchRoster(status.class, status.section);
            } else {
                document.getElementById('request-section').classList.remove('hidden');
            }
        }

        async function fetchRoster(c, s) {
            const res = await fetch(`${API}?get=roster`);
            const all = await res.json();
            const filtered = all.filter(x => x.class == c && x.section == s);
            document.getElementById('att-list').innerHTML = filtered.map(x => `
                <div class="student-item">
                    <span>${x.name}</span>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-p" onclick="mark('${x.name}','${x.roll}','Present','${c}','${s}')">P</button>
                        <button class="btn-a" onclick="mark('${x.name}','${x.roll}','Absent','${c}','${s}')">A</button>
                    </div>
                </div>
            `).join('') || "<p style='text-align:center; opacity:0.5'>Room empty</p>";
        }

        async function mark(n, r, s, cl, se) {
            toast("Recording " + s + "...");
            await fetch(API, { method: "POST", body: JSON.stringify({ action: "markAttendance", name: n, roll: r, status: s, class: cl, section: se, userEmail: sessionStorage.getItem('u_email') })});
            toast("Success!");
        }

        async function updateWebsite() {
            toast("Syncing to GitHub...");
            const res = await fetch(API, { method:"POST", body:JSON.stringify({ action:"pushToGitHub", adminEmail:ADMIN, htmlContent: document.documentElement.outerHTML })});
            toast(await res.text());
        }

        async function loadRequests() {
            const res = await fetch(`${API}?action=getRequests&email=${ADMIN}`);
            const reqs = await res.json();
            document.getElementById('request-list').innerHTML = reqs.map(r => `
                <div class="student-item" style="flex-direction:column; align-items:start;">
                    <b>${r[1]}</b> <small>${r[0]}</small>
                    <div style="display:flex; gap:10px; width:100%; margin-top:10px;">
                        <button onclick="adminAction('approveTeacher','${r[0]}','${r[2]}','${r[3]}')" style="background:var(--success); height:32px; font-size:12px; padding:0;">Allow</button>
                        <button onclick="adminAction('denyRequest','${r[0]}')" style="background:var(--danger); height:32px; font-size:12px; padding:0;">Deny</button>
                    </div>
                </div>
            `).join('') || "<p style='opacity:0.5; font-size:12px;'>No requests.</p>";
        }

        async function adminAction(act, email, cls, sec) {
            const res = await fetch(API, { method:"POST", body:JSON.stringify({ action:act, teacherEmail:email, targetClass:cls, targetSec:sec, adminEmail:ADMIN })});
            toast(await res.text());
            loadRequests();
        }

        async function addStudent() {
            const data = { action:"addStudent", adminEmail:ADMIN, name:document.getElementById('st-name').value, roll:document.getElementById('st-roll').value, class:document.getElementById('st-class').value, section:document.getElementById('st-sec').value };
            const res = await fetch(API, { method:"POST", body:JSON.stringify(data)});
            toast(await res.text());
        }

        async function sendRequest() {
            const u = sessionStorage.getItem('u_email');
            await fetch(API, { method: "POST", body: JSON.stringify({ action: "requestAccess", email: u, name: u.split('@')[0], class: document.getElementById('req-class').value, section: document.getElementById('req-sec').value }) });
            toast("Request Sent!");
        }

        function downloadCSV() { window.location.href = `${API}?action=downloadCSV&class=${encodeURIComponent(document.getElementById('assigned-room').innerText.split(' ')[0])}`; }
        function logout() { sessionStorage.clear(); location.reload(); }
    </script>
</body>
</html>
